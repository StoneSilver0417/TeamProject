<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Insert title here</title>
<link rel="stylesheet" th:href="@{/css/base.css}" />
<link rel="stylesheet" href="/css/style.css" />
<link rel="stylesheet" href="/css/main/header.css" />
<link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
<link rel="stylesheet" href="/css/main/footer.css" />
<script src="http://code.jquery.com/jquery-3.4.1.js"></script>
<style type="text/css">
.category {
	float: left;
	margin: 1%;
}
</style>
<script src="js/script.js"></script>
<script src="https://kit.fontawesome.com/267f657aa0.js"
	crossorigin="anonymous"></script>
<script>
	$(document).ready(function() {

		$('form').submit(function(e) {
			e.preventDefault();
			var keyword = $('#keyword').val();
			alert(keyword);
			$.ajax({
				url : "/manageUser/search-user/" + keyword,
				type : "POST",
				success : function(data) {
					$('table').html(data);
					//location.href = '/user/authority';
				},
				error : function() {
					alert('검색실패')

				}
			});
		});
	});

	// manager, user 권한 부여
	function addAndRemoveManagerBtn(action, id, name) {
		if (action == "add") {
			var check = confirm(name + '에게 매니저 권한을 부여하겠습니까?');
		} else if (action == "remove") {
			var check = confirm("'" + name + "' 을 일반 회원으로 변경하시겠습니까?");
		}

		if (check == true) {
			$.ajax({
				url : "/manageUser/" + action + "-manager/" + id,
				type : "PUT",
				dataType : 'text', // String 값을 return하기 때문
				success : function(message) {
					alert(message + '"' + name + '".');
					location.href = '/authority';
				},
				error : function() {
					alert(" 성공 !");
					location.href = '/authority';
				}
			})
		}
	};

	// user 영구 삭제 
	function deleteUserBtn(id, name) {
		//alert('deleteUserBtn') 
		var check1 = confirm('삭제하시겠습니까?');
		if (check1 == true) {
			var check2 = confirm("삭제시 복구가 불가합니다" + name + "삭제하시겠습니까?");
		}

		if (check2 == true) {
			$.ajax({
				url : "/manageUser/delete-user/" + id,
				type : "POST",
				dataType : 'text', // String 값을 return하기 때문
				success : function(message) {
					//alert(message);
					//location.replace('/manageUser');
					location.href = '/authority';
				},
				error : function() {
					alert('유저삭제실패');
					//location.replace('/manageUser');
				}
			})
		}
	};
	
	function search(){
		alert($('#keyword').val());
		$.ajax({
			url:'/search/user',
			type:'post',
			data:$('#keyword').val()
		})
	}
</script>

</head>
<body>
	<div th:replace="layout/header :: header"></div>

	<hr>
	<div class="container">
		<div class="page-header">
			<h1>관리자페이지</h1>
		</div>

		<div id="for__absolute">
			<form class="searchUser">
				<!-- title bar for search user -->
				<div class="searchUser__header">
					<img class="header__toolbar"> <img class="header__icon">
				</div>
				<!-- search user content -->
				<div class="searchUserInput"> 
					<input placeholder="검 색" id="keyword" maxlength="255" /> 
					<button type="button" onclick="search();" id="userSearchBtn" class="btn">검색</button>
				</div>
			</form>
		</div>


		</fieldset>
		<br /> <br /> <br />
		<div id="mainHide">
			<table class="table table-hover">
				<thead>
					<tr>
						<th scope="col">아이디</th>
						<th scope="col">닉네임</th>
						<th scope="col">권한</th>
						<th scope="col">레벨</th>
					</tr>
				</thead>
				<tbody style="text-align: center;">
					<tr th:each="list:${checkAll}">
						<td th:text="${list.userId}"></td>
						<td th:text="${list.userNickname}"></td>
						<td th:text="${list.userRole}"></td>
						<td th:text="${list.userExp}"></td>
						<td>
							<button th:if="${#strings.equals(list.userRole, 'USER')}"
								th:onclick="addAndRemoveManagerBtn('add', [[${list.userId}]], [[${list.userNickname}]])" 
								class="addManagerBtn btn">매니저 등록</button>

							<button th:if="${#strings.equals(list.userRole, 'MANAGER')}"
								th:onclick="addAndRemoveManagerBtn('remove', [[${list.userId}]], [[${list.userNickname}]])"
								class="removeManagerBtn btn">매니저 삭제</button>

							<button th:if="not ${#strings.equals(list.userRole, 'ADMIN')}"
								th:onclick="deleteUserBtn([[${list.userId}]], [[${list.userNickname}]])"
								class="deleteUserBtn btn">회원정지</button> 
								class="addManagerBtn btn">매니저 추가</button>

							<button th:if="${#strings.equals(list.userRole, 'MANAGER')}"
								th:onclick="addAndRemoveManagerBtn('remove', [[${list.userId}]], [[${list.userNickname}]])"
								class="removeManagerBtn btn">매니저 강등</button>

							<button th:if="not ${#strings.equals(list.userRole, 'ADMIN')}"
								th:onclick="deleteUserBtn([[${list.userId}]], [[${list.userNickname}]])"
								class="deleteUserBtn btn">유저 삭제</button> 
						</td>
					</tr>
				</tbody>
			</table>
		</div>
		<br />

	</div>
	<div th:replace="layout/footer :: footer"></div>
</body>

</html>